<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>@0b5vr/experimental - playground.html</title>
    <style>
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #000;
          color: #fff;
        }
      }

      #divExamples {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 32px;
        display: flex;
        padding: 0 8px;
        box-sizing: border-box;
        align-items: center;
      }

      #divEditor {
        position: fixed;
        left: 0;
        top: 32px;
        width: 100%;
        height: calc(80% - 32px);
        overflow: hidden;
      }

      #divContainer {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 20%;
        font-family: monospace;
        box-sizing: border-box;
        padding: 8px;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <div id="divExamples">
      <select id="selectExamples">
        <option value="euler">euler</option>
        <option value="matrix">matrix</option>
        <option value="oetf">oetf</option>
        <option value="poker">poker</option>
        <option value="yugop" selected>yugop</option>
      </select>
    </div>
    <div id="divEditor"></div>
    <div id="divContainer">
    </div>
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.4.4/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@0b5vr/experimental": "../dist/0b5vr-experimental.module.js"
        }
      }
    </script>
    <script src="https://unpkg.com/@monaco-editor/loader@1.2.0/lib/umd/monaco-loader.min.js"></script>
    <script type="module">
      const selectExamples = document.getElementById( 'selectExamples' );
      const divEditor = document.getElementById( 'divEditor' );
      const divContainer = document.getElementById( 'divContainer' );

      const darkMode = window.matchMedia( '(prefers-color-scheme: dark)' ).matches;

      const examples = {
        'euler': `import { Euler, Quaternion, Vector3 } from '@0b5vr/experimental';

export default ( ( { divContainer } ) => {
  const quat = Quaternion.fromAxisAngle( new Vector3( [ 1.0, 1.0, 1.0 ] ), 1.0 );

  divContainer.textContent = Euler.fromQuaternion( quat, 'XYZ' );
} );
`,
        'matrix': `import { Matrix4, Quaternion, Vector3 } from '@0b5vr/experimental';

export default ( ( { divContainer } ) => {
  const t = Matrix4.translate( new Vector3( [ 1.0, 2.0, 3.0 ] ) );
  const r = Quaternion.fromAxisAngle( new Vector3( [ 0.0, 1.0, 0.0 ] ), 0.25 * Math.PI ).matrix4;
  const s = Matrix4.scaleScalar( 5.0 );

  const matrix = Matrix4.multiply( t, r, s );

  divContainer.textContent = matrix;
} );
`,
        'oetf': `import { colorToHex, oetfRec709 } from '@0b5vr/experimental';

export default ( { divContainer } ) => {
  const colorRaw = [ 1.0, 0.5, 0.0 ];
  const colorLinear = oetfRec709( colorRaw );

  divContainer.innerHTML = '';

  const divRaw = document.createElement( 'div' );
  divRaw.style.width = '32px';
  divRaw.style.height = '32px';
  divRaw.style.background = colorToHex( colorRaw );
  divContainer.appendChild( divRaw );

  const divLinear = document.createElement( 'div' );
  divLinear.style.width = '32px';
  divLinear.style.height = '32px';
  divLinear.style.background = colorToHex( colorLinear );
  divContainer.appendChild( divLinear );
};
`,
        'poker': `import { createPokerDeck, evaluatePokerHand, shuffleArray } from '@0b5vr/experimental';

export default ( { divContainer } ) => {
  const deck = createPokerDeck();
  shuffleArray( deck );

  const myPocket = [ deck.pop(), deck.pop() ];

  let win = 0.0;

  [ ...Array( 10000 ) ].map( () => {
    const deckt = shuffleArray( deck.concat() );

    const opPocket = [ deckt.pop(), deckt.pop() ];
    const community = [ deckt.pop(), deckt.pop(), deckt.pop(), deckt.pop(), deckt.pop() ];

    const myHand = evaluatePokerHand( myPocket.concat( community ) );
    const opHand = evaluatePokerHand( opPocket.concat( community ) );

    const result = myHand.strength.reduce( ( prev, cur, i ) => {
      if ( prev === 0 ) {
        return Math.sign( cur - opHand.strength[ i ] );
      } else {
        return prev;
      }
    }, 0 );

    win += result;
  } );

  const winRatio = 0.5 + 0.5 * win / 10000.0;

  divContainer.textContent = \`hand: \${ myPocket.join( ', ' ) }\\nwinRatio: \${ ( winRatio * 100.0 ).toFixed( 2 ) } %\`;
};
`,
        'yugop': `import { ClockRealtime, getYugopText } from '@0b5vr/experimental';

export default ( { divContainer } ) => {
  let unmounted = false;

  const clock = new ClockRealtime();
  clock.play();

  const update = () => {
    if ( unmounted ) { return; }

    clock.update();

    divContainer.textContent = getYugopText( '@0b5vr/experimental', clock.time );

    requestAnimationFrame( update );
  };
  requestAnimationFrame( update );

  return () => {
    unmounted = true;
  };
};
`,
      };

      const monaco = await monaco_loader.init();

      fetch( '../dist/0b5vr-experimental.d.ts' )
        .then( ( res ) => res.text() )
        .then( async ( typedef ) => {
          console.log(typedef);
          monaco.languages.typescript.javascriptDefaults.addExtraLib( typedef, 'file:///node_modules/@types/0b5vr__experimental/index.d.ts' );
        } );

      const editor = monaco.editor.create( divEditor, {
        value: examples[ 'yugop' ],
        language: 'javascript',
        automaticLayout: true,
        theme: darkMode ? 'vs-dark' : 'vs-light',
        minimap: {
          renderCharacters: false,
        },
      } );

      let lastUnmount;

      const apply = () => {
        lastUnmount?.();

        const code = editor.getValue();
        const blob = new Blob( [ code ], { type: 'text/javascript' } );
        const url = URL.createObjectURL( blob );

        import( url ).then( ( mod ) => {
          lastUnmount = mod.default( { divContainer } );
          URL.revokeObjectURL( url );
        } );
      };
      apply();

      editor.addCommand( monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S, apply );
      editor.addCommand( monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_R, apply );

      selectExamples.addEventListener( 'change', () => {
        editor.getModel().setValue( examples[ selectExamples.value ] );
        apply();
      } );
    </script>
  </body>
</html>
